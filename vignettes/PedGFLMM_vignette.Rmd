---
title: "PedGFLMM Vignette"
author: "Yingda Jiang, Chi-yang Chiu, Daniel E. Weeks, Ruzong Fan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{PedGFLMM Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}

  pdf_document:
    toc: true
    number_sections: true
    toc_depth: 3
---

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```

# Overview

This document describes our R package `PedGFLMM` which implements family-based additive generalized linear mixed models (GLMM) and generalized functional linear mixed models (GFLMM) for gene-based association testing of dichotomous traits (Jiang et al, 2019). Section 2 briefly describes the installation of the program. Section 3 describes the data formats. Section 4 explains how to run the program using one example. Section 5 offers explanation of the results and warnings to use the programs. Section 6 provides some suggestions and parameter choices for real data analysis.

The theoretical basis for this program is given in our research papers in Section 7 "References" below; the primary paper describing this work is Jiang et al (2019). Please cite the references if you use our program
in any published work. In case of suggestions and questions and/or problems, you can contact us via e-mail (rf740\@georgetown.edu).

# Installation

The package is written in R language. To install, proceed as follows:

1. Download the source archive 'PedGFLMM_1.0.0.tar.gz' file.
2. Start up RStudio, and go to:

Tools -> Install Packages 

and set `Install from:` to `Package Archive File` and then select the `PedGFLMM_1.0.0.tar.gz` file.

Alternatively, proceed as follows:

1. Download the source archive 'PedGFLMM_1.0.0.tar.gz' file.
2. If you are using Windows, install the 'Rtools' R package from CRAN via this link https://cran.r-project.org/bin/windows/Rtools/

3. Start up R and proceed as follows:

```
install.packages("path_to_file",repos = NULL, type ="source", dependencies = TRUE)
```

where `path_to_file` is represent the full path to the file ending in 'PedGFLMM_1.0.0.tar.gz'.

After the `PedGFLMM` R package has been installed, you can view this vignette by issuing these commands at the R prompt:

```
library(PedGFLMM)
browseVignettes("PedGFLMM")
```


# Data Format

The program needs data frame in R to define the pedigree structure (typical format used by LINKAGE and PLINK), genotypes, SNP positions, and covariates. 

## The pedigree file
The pedigree file is in the same format as that used by the `pedgene` R package except for a column named `ID` (Schaid et al. 2013) and has the following columns:

* ID: identify of each individual.

* ped: pedigree ID, character or numeric allowed.

* person: person ID, a unique ID within each pedigree, numeric or character allowed.

* father: father ID, NA if no father.

* mother: mother ID, NA if no mother.

* sex: coded as 1 for male, 2 for female.

* trait: phenotype, either case-control status coded as 1 for affected and 0 for unaffected. Subjects with missing (NA) will be removed from the analysis.

```{r, echo=FALSE}
data("exampleData", package = "PedGFLMM")
kable(head(Ped), caption = "Table 1: The first 6 lines of the example pedigree file")
```


## The genotype file
The genotype file is a matrix with genotypes for subjects (rows) at each variant position (columns). The first two columns are required to be named 'ped' and 'person', which are used to match subjects to their data in the pedigree data.frame. The genotypes are coded as 0, 1, 2 for autosomal markers (typically a count of the number of the minor  allele). 

```{r, echo=FALSE}
kable(head(geno[,1:15]), caption = "Table 2: The first 6 lines of the example genotype file (first 15 columns)")
```


## The map file
The map file provides SNP positions for each SNP. The first column is required for the chromosome number, the second column is for the name of SNPs in the genotype file, and the third column is the position of SNPs in base pairs.

```{r, echo=FALSE}
kable(head(snpPos), caption = "Table 3: The first 6 lines of the example map file")
```


## The covariate file
The covariate file contains covariates. The first two columns are required to be named 'ped' and 
'person', which are used to match subjects to their data in the pedigree data.frame.

```{r, echo=FALSE}
kable(head(cov), caption = "Table 4: The first 6 lines of the example covariate file")
```



# How to Run the Program

There are three main functions in this package which implement the statistics described in Jiang et al (2019):

1. `PedGLMM_additive_effect_model`
2. `PedGFLMM_beta_smooth_only` 
3. `PedGFLMM_fixed_model`

After installing this `PedGFLMM` R package, you can access help pages for each of these functions easily, which contain example code.  For example, to access the help page for the `PedGFLMM_beta_smooth_only` function, proceed as follows in R:

```
library(PedGFLMM)
?PedGFLMM_beta_smooth_only
```

We also provide an example `Mega2PedGFLMM` function that illustrates how to use functions from the `Mega2R` R package to easily loop through genes, computing the `PedGFLMM_beta_smooth_only` statistics for each gene. 

## Load the example data

To illustrate the functions in this package, we first load the data.

```{r}
library(PedGFLMM)
data(exampleData)
# The 'exampleData' contains four data frames: Ped, geno, cov, snpPos
ls()
```


## The PedGLMM_additive_effect_model function

This function carries out a region-based association test using our additive generalized linear mixed model (GLMM), as described in Jiang et al (2019).  This statistics may not be powerful when the number of genetic variants is large.

```{r}
add=PedGLMM_additive_effect_model(ped=Ped, geno = as.matrix(geno),
   covariate = as.matrix(cov), distribution = 'binomial')
add
```


## The PedGFLMM_beta_smooth_only function

This function carries out a region-based association test using our 'beta smooth only' generalized functional linear mixed model (GFLMM), where the genetic effect function is assumed to be continuous/smooth. For details, see Jiang et al (2019). 

The genetic effect function can be expanded using either B-spline or Fourier basis functions, and the order and number of basis functions need to be specified by the user.

```{r}
betabasis_Bsp = 10
genobasis_Bsp = 10

betabasis_Fsp = 11
genobasis_Fsp = 11
order  =   4

bsmooth_bsp=PedGFLMM_beta_smooth_only(ped = Ped, geno = as.matrix(geno),
   pos = snpPos$pos, order = order, beta_basis=betabasis_Bsp, covariate = as.matrix(cov),
   base = "bspline", distribution = 'binomial')
bsmooth_bsp

bsmooth_fsp=PedGFLMM_beta_smooth_only(ped = Ped, geno = as.matrix(geno),
   pos = snpPos$pos, order = order, beta_basis=betabasis_Fsp, covariate = as.matrix(cov),
   base = "fspline", distribution = 'binomial')
bsmooth_fsp
```




## The PedGFLMM_fixed_model function

This function carries out a region-based association test using our generalized functional linear mixed model (GFLMM). For details, see Jiang et al (2019).

The genetic variant function (GVF) and the genetic effect function can be expanded using either B-spline or Fourier basis functions, and the order and number of basis functions need to be specified by the user.

```{r}
betabasis_Bsp = 10
genobasis_Bsp = 10

betabasis_Fsp = 11
genobasis_Fsp = 11
order  =   4

fixed_bsp=PedGFLMM_fixed_model(ped = Ped, geno = as.matrix(geno), pos = snpPos$pos,
    order = order, beta_basis=betabasis_Bsp, geno_basis = genobasis_Bsp,
    covariate = as.matrix(cov), base = "bspline", distribution = 'binomial')
fixed_bsp

fixed_fsp=PedGFLMM_fixed_model(ped = Ped, geno = as.matrix(geno), pos = snpPos$pos,
    order = order, beta_basis=betabasis_Fsp, geno_basis = genobasis_Fsp,
    covariate = as.matrix(cov), base = "fspline", distribution = 'binomial')
fixed_fsp
```


## The Mega2PedGFLMM function

The `Mega2PedGFLMM` function illustrates how to use functions from the `Mega2R` R package (Baron et al, 2018) to easily loop through genes, computing the `PedGFLMM_beta_smooth_only` statistics for each gene.  

It will skip genes that contain less than two polymorphic markers.

The `Mega2R` R package is designed to read a database of phenotypes and genetic data, created by the data-reformatting program `Mega2` (Baron et al, 2014), into R as a set of coordinated data frames.  Once these data are nicely accessible in R, then `Mega2R` functions can be used to loop through gene regions, computing statistics for each region. By studying the code of this example `Mega2PedGFLMM` function, one can figure out how to loop through one's own data in a similar fashion.   

```{r}
db = system.file("exdata", "seqsimmGFLMM.db", package="PedGFLMM")
ENV = init_PedGFLMM(db)
ENV$verbose = TRUE
Mega2PedGFLMM(gs = 53:54)
Mega2PedGFLMM(genes = "CEP104")
```


# Explanation of the Results and Warnings 

As shown above, our program outputs the p-value based on likelihood ratio test (LRT). The LRT is conservative and has good power performance. 

# Suggestions and Parameters for Real Data Analysis 

In this documentation, we present three R functions to perform gene-based association analysis of dichotomous traits using family data. The two PedGFLMM functions, 'PedGFLMM\_fixed\_model.R' and 'PedGFLMM\_beta\_smooth\_only.R', usually provide very similar results. In practice, one may use one of them for data analysis. We suggest to use PedGFLMM\_fixed\_model by either B-spline or Fourier spline basis functions and report the $p$-values of LRT. If the number of SNPs is not very big, we suggest the following parameters for a data analysis:

```
order  =  4
bbasis = 10
gbasis = 10
fbasis = 11
gfasis = 11
```

If the number of SNPs is large, one should try
```
order  =  4
bbasis = 15
gbasis = 15
fbasis = 16
gfasis = 16
```
or even bigger numbers. The point is that the parameters should be large enough to sufficiently expand information of the genetic data, but can not be too large to decrease the power.

#  References

Baron RV, Kollar C, Mukhopadhyay N, Weeks DE. (2014) Mega2: validated data-reformatting for linkage and association analyses. _Source Code Biol Med._ __9(1)__:26. doi: 10.1186/s13029-014-0026-y.

Baron RV, Stickel JR, Weeks DE. (2018) The Mega2R package: R tools for accessing and processing genetic data in common formats. _F1000Res._ __29(7)__:1352. doi: 10.12688/f1000research.15949.1.

Chiu CY, Yuan F, Zhang BS, Yuan A, Li X, Fang HB, Lange K, Weeks DE, Wilson AF, Bailey-Wilson JE, Lakhal-Chaieb ML, Cook RJ, McMahon FJ, Amos CI, Xiong MM, and Fan RZ (2019) Pedigree-based linear mixed models for association analysis of quantitative traits with next-generation sequencing data. _Genetic Epidemiology_ __43(2)__:189-206.

Fan RZ, Wang YF, Mills JL, Wilson AF, Bailey-Wilson JE, and Xiong MM (2013) Functional linear models for association analysis of quantitative traits. _Genetic Epidemiology_ __37(7)__:726-742.

Fan RZ, Wang YF, Mills JL, Carter TC, Lobach I, Wilson AF, Bailey-Wilson JE, Weeks DE, and Xiong MM (2014) Generalized functional linear models for case-control association studies. _Genetic Epidemiology_ __38(7)__:622-637.

Jiang YD, Chiu CY, Yan Q, Chen W, Gorin MB, Conley YP, Lakhal-Chaieb ML, Cook RJ, Amos CI, Wilson AF, Bailey-Wilson JE, McMahon FJ, Vazquez AI, Yuan A, Zhong XG, Xiong MM, Weeks DE, and Fan RZ (2019) Gene-based association testing of dichotomous traits with generalized linear mixed models for family data.

Schaid DJ, McDonnell SK, Sinnwell JP, and Thibodeau SN (2013) Multiple genetic variant association testing by collapsing and kernel methods with pedigree or population structured data. _Genetic Epidemiology_ __37__:409-418.


# Session Information

```{r}
sessionInfo()
```

